<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Associations in LINQ To DB | Linq To DB (aka linq2db) </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Associations in LINQ To DB | Linq To DB (aka linq2db) ">
    <meta name="generator" content="docfx 2.42.4.0">
    
    <link rel="shortcut icon" href="../../images/icon.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    <meta property="docfx:rel" content="../../">
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../images/icon.png" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list"></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="associations-in-linq-to-db">Associations in LINQ To DB</h1>

<p>Association defines how entities relate to each other. It can be representation of foreign key constraint or custom query which can be automaticaly handled by <code>LINQ To DB</code>.</p>
<p>Associations is powerful mechanism in <code>LINQ To DB</code>, not so limited as in vanilla frameworks. Since <code>LINQ To DB</code> do not track changes we can express any idea using associations to simplify writing of LINQ queies.</p>
<h2 id="in-this-article">In this article</h2>
<p><a href="#one-to-one-associations">One-to-one associations</a></p>
<p><a href="#one-to-many-associations">One-to-many associations</a></p>
<p><a href="#associations-as-extension-methods">Associations as extension methods</a></p>
<h2 id="one-to-one-associations">One-To-One Associations</h2>
<p>It is simple relation between two entities and can be defined using <code>AssociationAttribute</code>.
In example below we show how to define optional one-to-one association between <code>Order</code> and <code>Employee</code> entities.</p>
<pre><code class="lang-cs">public partial class Order
{
    [Association(
        ThisKey   = nameof(EmployeeID),
        OtherKey  = nameof(Models.Employee.EmployeeID),
        CanBeNull = true)]
    public Employee Employee { get; set; }
}
</code></pre><pre><code class="lang-cs">var query = from order in db.Orders
   where order.Employee.Address.StartsWith(&quot;B&quot;)
   select new
   {
      order.OrderID,
      order.OrderDate,
      order.Employee.Address,
   };
</code></pre><p><code>ThisKey</code> and <code>OtherKey</code> contain comma-separated names of members of appropriate entities, used in join condition. <code>CanBeNull = true</code> means that relation is optional and forces engine to join entities using <code>LEFT JOIN</code> instead of <code>INNER JOIN</code> for non-optional relations.</p>
<h2 id="one-to-many-associations">One-To-Many Associations</h2>
<p>This association simplifies queries from <code>Main</code> entity to <code>Related</code> entities. Usually it is a property with <code>IEnumerable&lt;T&gt;</code> type, which can be also of <code>List&lt;T&gt;</code> or <code>T[]</code> type.</p>
<pre><code class="lang-cs">public partial class Order
{
    [Association(
    ThisKey  = nameof(OrderID),
        OtherKey = nameof(OrderDetail.OrderID))]
    public IEnumerable&lt;OrderDetail&gt; Details { get; set; }
}
</code></pre><p>It helps to write queries like that:</p>
<pre><code class="lang-cs">   var query = from order in db.Orders
      where order.Details.Any(d =&gt; d.Discount &gt; 0.06)
      select new
      {
         order.EmployeeID,
         MaxDicount = order.Details.Max(d =&gt; d.Discount)
      };
</code></pre><p>Except joins on specified set of key-fields, you can also define custom join condition. You need to define static function which returns <code>Expression</code>-typed join predicate. It should be expression function with two parameters <code>Main</code> and <code>Related</code> and return <code>bool</code> result.</p>
<pre><code class="lang-cs">public partial class Order
{
    [Association(ExpressionPredicate = nameof(DetailsWithBigDiscountFilter))]
    public IEnumerable&lt;OrderDetail&gt; DetailsWithBigDiscount { get; set; }

    private static Expression&lt;Func&lt;Order, OrderDetail, bool&gt;&gt; DetailsWithBigDiscountFilter()
    {
        return (order, detail) =&gt; order.OrderID == detail.OrderID &amp;&amp; detail.Discount &gt; 0.06;
    }
}
</code></pre><p>In this example <code>ThisKey</code> and <code>OtherKey</code> were replaced with custom predicate, but if they are defined, predicate will be combined with keys using <code>AND</code> condition.</p>
<p>Now query from previous example could be simplified using new association:</p>
<pre><code class="lang-cs">var query = from order in db.Orders
   where order.DetailsWithBigDiscount.Any()
   select new
   {
      order.EmployeeID,
      MaxDiscount = order.DetailsWithBigDiscount.Max(d =&gt; d.Discount)
   };
</code></pre><h2 id="associations-as-extension-methods">Associations as Extension Methods</h2>
<p>There are situations when changing model is not allowed or it is located in separate library, so you cannot add assiciations to model class itself.
For this case <code>LINQ To DB</code> has ability to define associations as extension methods.
Previous examples can be rewritten to use extension methods:</p>
<pre><code class="lang-cs">public static class NorthwindExtensions
{
    [Association(
        ThisKey   = nameof(Order.EmployeeID),
        OtherKey  = nameof(Models.Employee.EmployeeID),
        CanBeNull = true)]
    public static Employee Employee(this Order order)
    {
        throw new InvalidOperationException(&quot;Called outside of query&quot;);
    }

    [Association(
        ThisKey  = nameof(Order.OrderID),
        OtherKey = nameof(OrderDetail.OrderID))]
    public static IEnumerable&lt;OrderDetail&gt; Details(this Order order)
    {
        throw new InvalidOperationException(&quot;Called outside of query&quot;);
    }
}
</code></pre><pre><code class="lang-cs">var query = from order in db.Orders
   where order.Details().Any(d =&gt; d.Discount &gt; 0.06)
   select new
   {
      order.EmployeeID,
      MaxDicount = order.Details().Max(d =&gt; d.Discount)
   };
</code></pre><p>As we can see from extension methods implemenation - they do not support execution and should be used only as declarative methods in linq query.
But there are cases when it is required to query details exactly from materialized object.</p>
<p>For such cases you can define additional parameter in extension method of <code>IDataContext</code>-based type, e.g. <code>IDataContext</code>, <code>DataConnection</code> or <code>NotrthwindDB</code> from this article.</p>
<p>Extension method should return <code>IQueryable&lt;T&gt;</code> interface.</p>
<pre><code class="lang-cs">public static class NorthwindExtensions
{
    [Association(
        ThisKey = nameof(Order.OrderID),
        OtherKey = nameof(OrderDetail.OrderID))]
    public static IQueryable&lt;OrderDetail&gt; DetailsQuery(this Order order, IDataContext db)
    {
        return db.GetTable&lt;OrderDetail&gt;().Where(d =&gt; d.OrderID == order.OrderID);
    }
}
</code></pre><p>The same techinque can be applied to entity methods. (<strong>TODO:clarify what it means</strong>)</p>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/linq2db/docs/blob/merge/source/articles/model/associations.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            Copyright © 2011-2019 linq2db.com<br><br>Generated by <strong>DocFX</strong>
            
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
